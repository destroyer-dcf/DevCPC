; FILE GENERATED BY ABASC COMPILER
; DESIGNED TO BE ASSEMBLED BY ABASM
;

org  &40
jp   _startup_
    
; DYNAMIC MEMORY AREA (HEAP), USED BY MALLOC AND FREE
rt_heapmem_next:  dw rt_heapmem; pointer to free memory for dynamic allocation
rt_heapmem_start: dw rt_heapmem; reserved area for dynamic allocated memory
rt_heapmem:       defs 0      ; reserved area for dynamic allocated memory
rt_heapmem_end:   db &DE,&AD  ; DEAD mark
    

; PROGRAM MAIN
_startup_:
    call    rt_restoreroms
_restoreroms_end:
    ld      de,240
    ld      hl,_symbols_table
    call    &BBAB             ; TXT_SET_M_TABLE
_startup_end_:
_code_:
    __label_10:               ; 10 MODE 1
    ld      a,1 & 0xFF
    call    &BC0E             ; SCR_SET_MODE
    __label_20:               ; 20 BORDER 26
    ld      c,26 & 0xFF
    ld      b,c
    call    &BC38             ; SCR_SET_BORDER
    __label_30:               ; 30 INK 0,26: INK 1,0: INK 2,9: INK 3,18
    ld      c,26 & 0xFF
    ld      b,c
    ld      a,0 & 0xFF
    call    &BC32             ; SCR_SET_INK
    ld      c,0 & 0xFF
    ld      b,c
    ld      a,1 & 0xFF
    call    &BC32             ; SCR_SET_INK
    ld      c,9 & 0xFF
    ld      b,c
    ld      a,2 & 0xFF
    call    &BC32             ; SCR_SET_INK
    ld      c,18 & 0xFF
    ld      b,c
    ld      a,3 & 0xFF
    call    &BC32             ; SCR_SET_INK
    __label_40:               ; 40 LOAD "KEY.SCN",&C000
    ld      hl,49152
    ex      de,hl
    ld      hl,__const_str_1
    call    rt_loadaddr
    __label_50:               ; 50 LOCATE 12,20
    ld      hl,12
    ex      de,hl
    ld      hl,20
    ld      h,e
    call    &BB75             ; TXT_SET_CURSOR
    __label_60:               ; 60 PRINT "SDK for AMSTRAD CPC"
    ld      hl,__const_str_2
    call    rt_print_str
    call    rt_print_nl
    __label_70:               ; 70 CALL &C000: GOTO 70
    call     49152            ; calling 0xc000
    jp      __label_70
    
_code_end_: jr _code_end_     ; infinite end loop

_runtime_:


; RT_RESTOREROMS
; Based on https://www.cpcmania.com/Docs/Programming/Ficheros.htm
; This rutine initializes again all ROMs, enabling, for example,
; the AMSDOS rom so commands related to disc/tape work.
; Inputs:
;   None
; Outputs:
;   None
;   AF, HL, DE and BC are modified
rt_restoreroms:
    ld      hl,(&be7d)             ; store the drive number the program was run from
    ld      a,(hl)                 ; usually that is in &a700 
    ld      (__restore_drive+1),a  ; self-modifying code
    ld      c,&ff                  ; disable all roms
    ld      hl, __restore_start    ; execution address for program
    call    &BD16                  ; MC_START_PROGRAM
__restore_start: db 0
    call    &BCCB                  ; KL_ROM_WALK to initialize all roms 
__restore_drive: 
    ld      a, &00                 ; restore the drive number
    ld      hl,(&be7d)             ; because when eneabling AMSDOS the drive
    ld      (hl),a                 ; reverts to 0
    jp      _restoreroms_end       ; jump back without a ret as the stack is empty

; RT_LOADADDR
; Reads an AMSDOS file (with header) and extracts its length.
; The content is loaded into the address stored in DE.
; Inputs:
;   HL address to the file name
;   DE address where content must be loaded
; Outputs:
;   CF if no error
;   AF, HL, BC, DE and IX are modified
rt_loadaddr:
    push    de
    ld      de,0   ; 2K buffer not needed with CAS_IN_DIRECT
    ld      b,(hl) ; filename length
    inc     hl
    call    &BC77  ; CAS_IN_OPEN
    ret     nc     ; Error
    pop     hl
    call    &BC83  ; CAS_IN_DIRECT
    jp      &BC7A  ; CAS_IN_CLOSE

; RT_PRINT_STR
; Prints in the screen the string pointed by HL
; using the Amstrad CPC firmware routines
; Inputs:
;     HL address to the string to print
; Outputs:
;     AF, HL and BC are modified
rt_print_str:
    ld      a,(hl)
    or      a
    ret     z          ; empty string
    ld      b,a
__print_str_loop:
    inc     hl
    ld      a,(hl)
    call    &BB5A  ; TXT_OUTPUT
    djnz    __print_str_loop
    ret

; RT_PRINT_NL
; Prints an EOL which in Amstrad is composed
; by chraracters 0x0D 0x0A
; Inputs:
;     None 
; Outputs:
;     None 
;     AF is modified
rt_print_nl:
    ld      a,13
    call    &BB5A  ; TXT_OUTPUT
    ld      a,10
    jp      &BB5A  ; TXT_OUTPUT

_runtime_end_:

; DATA must be allocated outside of Firmware memory area
if ($ < &4000)
    org  &4000
endif
_data_:
    
; Table for symbols defined with SYMBOL keyword
; 16 elements x 8 bytes
_symbols_table: defs 128

_data_constants_:
    __const_str_1: db 7,&4B,&45,&59,&2E,&53,&43,&4E; 'KEY.SCN'
    __const_str_2: db 19,&53,&44,&4B,&20,&66,&6F,&72,&20,&41,&4D,&53,&54,&52,&41,&44,&20,&43,&50,&43; 'SDK for AMSTRAD CPC'

_data_constants_end_:
_data_variables_:

_data_variables_end_:
_data_datablock_:

_data_datablock_end_:
_data_end_:
_program_end_:
